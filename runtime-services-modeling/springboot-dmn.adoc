= DMN business services with Springboot
include::../partials/attributes.adoc[]

You can create a BAMOE application using decision engine and Spring Boot framework support.

During the compilation, some code is automatically generated by a specific Maven plugin where part of code is common and rest of it is engine-specific.
For each model, REST endpoints are generated, that are specific to the model and the engine.
Developers can add custom classes to the BAMOE application to provide additional functionality, which will be built with the automatically generated code as in normal Java applications.

== Dependencies

The dependencies required for a decision application with Spring Boot support are:

[source]
----
org.drools:drools-decisions-spring-boot-starter
org.springframework.boot:spring-boot-starter-actuator
----

The two dependencies also transitively bring in all the other needed dependencies.
Beside the listed ones, there are other dependencies a user may add for development purposes, for example, tests, and development support.
These may include:

[source]
----
org.kie.kogito:kogito-scenario-simulation
----
This is needed to embed SCESIM testing functionality

[source]
----
org.springframework.boot:spring-boot-devtools
----
This is needed to enable hot-reload during development

Finally, the following plugins are required to correctly build and package the application:

[source]
----
org.kie.kogito:kogito-maven-plugin
org.springframework.boot:spring-boot-maven-plugin
----

== Setup

The core of the BAMOE-application configuration is inside the root POM.
First of all, the BAMOE target version must be identified.
Then, there is a Bill of Materials (BOM) that is used to simplify dependency management, to be declared in the dependencyManagement section, enabling you to control dependencies and their versions via the BOM without changing the POM file. 

[source]
----
org.kie.kogito:kogito-spring-boot-bom
org.springframework.boot:spring-boot-devtools
----

Here is an example of a POM with SCESIM and devtools support:

[source]
----
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>org.kie.kogito.demos</groupId>
  <artifactId>dmn-springboot-demo</artifactId>
  <version>1.0-SNAPSHOT</version>
  <properties>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <version.org.kie.kogito>999-SNAPSHOT</version.org.kie.kogito>
    <version.kogito.bom>999-SNAPSHOT</version.kogito.bom>
    <version.org.springframework.boot>3.2.6</version.org.springframework.boot>
  </properties>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.kie.kogito</groupId>
        <artifactId>kogito-spring-boot-bom</artifactId>
        <version>${version.kogito.bom}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <version>${version.org.springframework.boot}</version>
        <optional>true</optional>
      </dependency>
    </dependencies>
  </dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-devtools</artifactId>
      <optional>true</optional>
    </dependency>
    <dependency>
      <groupId>org.drools</groupId>
      <artifactId>drools-decisions-spring-boot-starter</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-test</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.rest-assured</groupId>
      <artifactId>rest-assured</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.kie.kogito</groupId>
      <artifactId>kogito-scenario-simulation</artifactId>
      <scope>test</scope>
    </dependency>
  </dependencies>
  <build>
    <finalName>${project.artifactId}</finalName>
    <pluginManagement>
      <plugins>
        <plugin>
          <groupId>org.kie.kogito</groupId>
          <artifactId>kogito-maven-plugin</artifactId>
          <version>${version.org.kie.kogito}</version>
        </plugin>
        <plugin>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-maven-plugin</artifactId>
          <version>${version.org.springframework.boot}</version>
        </plugin>
      </plugins>
    </pluginManagement>
    <plugins>
      <plugin>
        <groupId>org.kie.kogito</groupId>
        <artifactId>kogito-maven-plugin</artifactId>
        <executions>
          <execution>
            <phase>compile</phase>
            <goals>
              <goal>generateModel</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
        <executions>
          <execution>
            <goals>
              <goal>repackage</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>
----

Beside the POM, the 'application.properties' file is required to further customize the application with Spring Boot or BAMOE specific properties (for example, server.address).
Lastly, a 'logback.xml' file should be provided to customize logging output.

== Structure

A Decision application has the usual Maven structure
(module).

[source]
----
  src/
    main/
      /java
      /resources
    test/
      /java
      /resources
----

Model(s), 'application.properties' and 'logback.xml' files have to be written under the 'main/resource directory' (to change the behavior during test execution, 'application.properties' and 'logback.xml' could also be written in 'test/resources').

Generated code will be generated in 'target/generated-sources/kogito'.

== Code

As in all Spring Boot applications, an entry point class annotated with @SpringBootApplication is required. This is a simple example:

[source]
----
@SpringBootApplication(scanBasePackages = { "org.kie.kogito.dmn.**", "org.kie.kogito.app.**", "http**" })

public class KogitoSpringbootApplication {
    public static void main(String[] args) {
        SpringApplication.run(KogitoSpringbootApplication.class, args);
    }
}

----

== Testing

For full integration tests, testing classes should be annotated as '@SpringBootTest', eventually injecting required managed properties or beans.
Here is an example that verifies the response received when posting an HTTP request on a given (automatically generated) entry point:

[source]
----
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT, classes = KogitoSpringbootApplication.class)
@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_EACH_TEST_METHOD)
public class TrafficViolationTest {
    @LocalServerPort
    private int port;
    @BeforeEach
    public void setUp() {
        RestAssured.port = port;
    }
    @Test
    public void testEvaluateTrafficViolation() {
        given()
                .body("{\n" +
                        "    \"Driver\": {\n" +
                        "        \"Points\": 2\n" +
                        "    },\n" +
                        "    \"Violation\": {\n" +
                        "        \"Type\": \"speed\",\n" +
                        "        \"Actual Speed\": 120,\n" +
                        "        \"Speed Limit\": 100\n" +
                        "    }\n" +
                        "}")
                .contentType(ContentType.JSON)
                .when()
                .post("/Traffic Violation")
                .then()
                .statusCode(200)
                .body("'Should the driver be suspended?'", is("No"));
    }
}

----

== SCESIM

Scenario Simulation (SCESIM) is a testing tool used to verify the response of the decision engine following a series of invocations. It uses a '*.scesim' file that describes all the tested scenarios. The file may be created or edited using the Decision editor, and should be saved in the 'test/resources' folder. In addition, a runner class is required in the 'src/test/java/testscenario' package; here is an example:

[source]
----
@org.junit.runner.RunWith(org.kogito.scenariosimulation.runner.KogitoJunitActivator.class)
public class KogitoScenarioJunitActivatorTest { }
----

== Compilation

During Maven’s compilation phase, the 'kogito-maven-plugin' scans the 'main/resources' directory to find any '*.dmn' files. For each discovered file, the decision engine creates REST classes, with endpoints specifically to:

.	Retrieve the original model
.	Execute the model
. Execute the model and retrieve “explanation” information

The classes are generated under a package whose name reflects the namespace of the dmn file, while the name of the generated class, and the endpoint root, is derived from the name of the model itself.

== Testing

During Maven’s test phase, all the scenarios defined in the SCESIM file are executed as a single unit test, and the results are saved in the 'target/surefire-reports' folder. At the same time, all other unit tests and integration tests are executed and their results stored in the same folder.

== Execution during development

The following Maven command will compile from scratch and start the Spring Boot application:

[source]
----
mvn clean compile spring-boot:run
----

After a successful start, the application will be available at `http://:0.0.0.0:8080` address (IP depends on application.properties configuration).
The swagger-ui page `(http://0.0.0.0:8080/swagger-ui/index.html)` shows all the generated endpoints, providing a way to quickly verify them.

The following command may be used to simply compile and test the application, without starting it:

[source]
----
mvn clean verify
----

== Hot-reload

For medium to large sized applications, recompiling and restarting the application upon code changes could be cumbersome and time-consuming. To simplify that, the Spring Boot framework offers https://docs.spring.io/spring-boot/docs/3.2.6/reference/html/using.html#using.devtools[devtools]

The condition is that the classpath has to be "manually" rebuilt to trigger the reload. 
Since the BAMOE-application also relies on automatic code-generation driven by models and executed by the 'kogito-maven-plugin', the approach is to:

.	Create a mvn clean compile command/button (details vary by IDE) to be fired on-demand
.	Start the application with mvn clean compile spring-boot:run
.	Execute the command at point 1 when it is required to reload changes.

== Debugging

The way to debug the application without using specific IDE tools or plug-ins, relies on the standard Java remote debug setup:

-	Create a remote debug configuration on port 8000 (details vary by IDE)
-	Start application in debug mode
[source]
----
mvn clean compile spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000"
----
-	Put a breakpoint in some of the code-generated sources
- Connect the remote debugger

== Package and run

Standard Maven/Java commands are required to package and start the generated application. Following are the commands:

.	mvn clean package
.	java -jar ./target/(name_of_the_application).jar



. In the Maven project that was created in the xref:../getting-started/project-setup.adoc[Initial Project Setup and Walkthrough] section, navigate to the `src/main/java/com/ibm` folder and add the following `Person.java` file:
+
--
.Example person Java object
[source,java]
----
package com.ibm;

import java.io.Serializable;

public class Person {

	private String name;
	private int age;
	private boolean adult;

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public int getAge() {
		return age;
	}

	public void setAge(int age) {
		this.age = age;
	}

	public boolean isAdult() {
		return adult;
	}

	public void setAdult(boolean adult) {
		this.adult = adult;
	}

	@Override
	public String toString() {
		return "Person [name=" + name + ", age=" + age + ", adult=" + adult + "]";
	}

}
----
This example Java object sets and retrieves a person's name, age, and adult status.
--
. Navigate to the `src/main/resources` folder and add the following `PersonDecisions.dmn` DMN decision model or continue to create it from scratch:
+
--

[id=example-person-decisions-dmn]
.Example PersonDecisions DMN file
[source,xml]
----
<dmn:definitions xmlns:dmn="http://www.omg.org/spec/DMN/20180521/MODEL/" xmlns="https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1" xmlns:di="http://www.omg.org/spec/DMN/20180521/DI/" xmlns:kie="http://www.drools.org/kie/dmn/1.2" xmlns:dmndi="http://www.omg.org/spec/DMN/20180521/DMNDI/" xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/" xmlns:feel="http://www.omg.org/spec/DMN/20180521/FEEL/" id="_84B432F5-87E7-43B1-9101-1BAFE3D18FC5" name="PersonDecisions" typeLanguage="http://www.omg.org/spec/DMN/20180521/FEEL/" namespace="https://kiegroup.org/dmn/_52CEF9FD-9943-4A89-96D5-6F66810CA4C1">
  <dmn:extensionElements/>
  <dmn:itemDefinition id="_DEF2C3A7-F3A9-4ABA-8D0A-C823E4EB43AB" name="tPerson" isCollection="false">
    <dmn:itemComponent id="_DB46DB27-0752-433F-ABE3-FC9E3BDECC97" name="Age" isCollection="false">
      <dmn:typeRef>number</dmn:typeRef>
    </dmn:itemComponent>
    <dmn:itemComponent id="_8C6D865F-E9C8-43B0-AB4D-3F2075A4ECA6" name="Name" isCollection="false">
      <dmn:typeRef>string</dmn:typeRef>
    </dmn:itemComponent>
    <dmn:itemComponent id="_9033704B-4E1C-42D3-AC5E-0D94107303A1" name="Adult" isCollection="false">
      <dmn:typeRef>boolean</dmn:typeRef>
    </dmn:itemComponent>
  </dmn:itemDefinition>
  <dmn:inputData id="_F9685B74-0C69-4982-B3B6-B04A14D79EDB" name="Person">
    <dmn:extensionElements/>
    <dmn:variable id="_0E345A3C-BB1F-4FB2-B00F-C5691FD1D36C" name="Person" typeRef="tPerson"/>
  </dmn:inputData>
  <dmn:decision id="_0D2BD7A9-ACA1-49BE-97AD-19699E0C9852" name="isAdult">
    <dmn:extensionElements/>
    <dmn:variable id="_54CD509F-452F-40E5-941C-AFB2667D4D45" name="isAdult" typeRef="boolean"/>
    <dmn:informationRequirement id="_2F819B03-36B7-4DEB-AED6-2B46AE3ADB75">
      <dmn:requiredInput href="#_F9685B74-0C69-4982-B3B6-B04A14D79EDB"/>
    </dmn:informationRequirement>
    <dmn:decisionTable id="_58370567-05DE-4EC0-AC2D-A23803C1EAAE" hitPolicy="UNIQUE" preferredOrientation="Rule-as-Row">
      <dmn:input id="_ADEF36CD-286A-454A-ABD8-9CF96014021B">
        <dmn:inputExpression id="_4930C2E5-7401-46DD-8329-EAC523BFA492" typeRef="number">
          <dmn:text>Person.Age</dmn:text>
        </dmn:inputExpression>
      </dmn:input>
      <dmn:output id="_9867E9A3-CBF6-4D66-9804-D2206F6B4F86" typeRef="boolean"/>
      <dmn:rule id="_59D6BFF0-35B4-4B7E-8D7B-E31CB0DB8242">
        <dmn:inputEntry id="_7DC55D63-234F-497B-A12A-93DA358C0136">
          <dmn:text>&gt; 18</dmn:text>
        </dmn:inputEntry>
        <dmn:outputEntry id="_B3BB5B97-05B9-464A-AB39-58A33A9C7C00">
          <dmn:text>true</dmn:text>
        </dmn:outputEntry>
      </dmn:rule>
      <dmn:rule id="_8FCD63FE-8AD8-4F56-AD12-923E87AFD1B1">
        <dmn:inputEntry id="_B4EF7F13-E486-46CB-B14E-1D21647258D9">
          <dmn:text>&lt;= 18</dmn:text>
        </dmn:inputEntry>
        <dmn:outputEntry id="_F3A9EC8E-A96B-42A0-BF87-9FB1F2FDB15A">
          <dmn:text>false</dmn:text>
        </dmn:outputEntry>
      </dmn:rule>
    </dmn:decisionTable>
  </dmn:decision>
  <dmndi:DMNDI>
    <dmndi:DMNDiagram>
      <di:extension>
        <kie:ComponentsWidthsExtension>
          <kie:ComponentWidths dmnElementRef="_58370567-05DE-4EC0-AC2D-A23803C1EAAE">
            <kie:width>50</kie:width>
            <kie:width>100</kie:width>
            <kie:width>100</kie:width>
            <kie:width>100</kie:width>
          </kie:ComponentWidths>
        </kie:ComponentsWidthsExtension>
      </di:extension>
      <dmndi:DMNShape id="dmnshape-_F9685B74-0C69-4982-B3B6-B04A14D79EDB" dmnElementRef="_F9685B74-0C69-4982-B3B6-B04A14D79EDB" isCollapsed="false">
        <dmndi:DMNStyle>
          <dmndi:FillColor red="255" green="255" blue="255"/>
          <dmndi:StrokeColor red="0" green="0" blue="0"/>
          <dmndi:FontColor red="0" green="0" blue="0"/>
        </dmndi:DMNStyle>
        <dc:Bounds x="404" y="464" width="100" height="50"/>
        <dmndi:DMNLabel/>
      </dmndi:DMNShape>
      <dmndi:DMNShape id="dmnshape-_0D2BD7A9-ACA1-49BE-97AD-19699E0C9852" dmnElementRef="_0D2BD7A9-ACA1-49BE-97AD-19699E0C9852" isCollapsed="false">
        <dmndi:DMNStyle>
          <dmndi:FillColor red="255" green="255" blue="255"/>
          <dmndi:StrokeColor red="0" green="0" blue="0"/>
          <dmndi:FontColor red="0" green="0" blue="0"/>
        </dmndi:DMNStyle>
        <dc:Bounds x="404" y="311" width="100" height="50"/>
        <dmndi:DMNLabel/>
      </dmndi:DMNShape>
      <dmndi:DMNEdge id="dmnedge-_2F819B03-36B7-4DEB-AED6-2B46AE3ADB75" dmnElementRef="_2F819B03-36B7-4DEB-AED6-2B46AE3ADB75">
        <di:waypoint x="504" y="489"/>
        <di:waypoint x="404" y="336"/>
      </dmndi:DMNEdge>
    </dmndi:DMNDiagram>
  </dmndi:DMNDI>
</dmn:definitions>
----
This example DMN model consists of a basic DMN input node and a decision node defined by a DMN decision table with a custom structured data type.

In VS Code, you can add the xref:../tools/developer-tools-for-vscode.adoc[*{VS_CODE_BUNDLE}*] to design the decision requirements diagram (DRD), boxed expression, and data types with the DMN modeler.

To create this DMN model example in VSCode using the DMN modeler, follow these steps:

.. Create a `PersonDecisions.dmn` file, after the editor finishes loading, click the *Properties* icon in the upper-right corner of the DMN modeler, and confirm that the DMN model *Name* is set to `PersonDecisions`.
.. In the left palette, select *DMN Input Data*, drag the node to the canvas, and double-click the node to name it `Person`.
.. In the left palette, drag the *DMN Decision* node to the canvas, double-click the node to name it `isAdult`, and link to it from the input node.
+
.Example `PersonDecisions` DMN decision requirements diagram (DRD)
image::kogito-dmn-example-person.png[Image of PersonDecisions decision diagram]

.. In the upper tab options, select the *Data Types* tab and add the following `tPerson` structured data type and nested data types:
+
.Example DMN data types
image::kogito-dmn-example-person-data-types.png[Image of PersonDecisions data types]
.. After you define the data types, select the *Editor* tab to return to the DMN modeler canvas.
.. Select the *Person* input node, click the *Properties* icon, and under *Information item*, set the *Data type* to `tPerson`.
.. Select the *isAdult* decision node, click the *Properties* icon, and under *Information item*, set the *Data type* to `boolean`.

.. Select the decision node to display the node options and click the *Edit* icon to open the DMN boxed expression editor to define the decision logic for the node.
.. Click the _undefined expression_ field and select *Decision Table*.
.. Click the upper-left corner of the decision table to set the hit policy to *Unique*.
.. Set the input and output columns so that the input source `Person.Age` with type `number` determines the age limit and the output target `isAdult` with type `boolean` determines adult status:
+
.Example DMN decision table for `isAdult` decision
image::kogito-dmn-example-person-logic.png[Image of PersonDecisions decision table]
.. Save the DMN decision file.
--
. With everything in place, you can start the Quarkus server with the following command in the project root:
+
[source,console]
----
mvn quarkus:dev
----
+
Then you can check the application Swagger UI at `http://localhost:8080/q/swagger-ui/#/`
